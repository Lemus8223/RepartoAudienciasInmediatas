<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reparto de Audiencias Complejas - CSJ Soacha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Logos desde carpeta local */
        .logo-rama-judicial {
            width: 140px;
            height: 140px;
            background-image: url('./css/images/logo-rama-judicial.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .logo-ingenieria {
            width: 140px;
            height: 140px;
            background-image: url('./css/images/logo-ingenieria.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .header-container {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        @media (max-width: 768px) {
            .logo-rama-judicial,
            .logo-ingenieria {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="w-full max-w-6xl mx-auto p-6"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configuraci√≥n de Google Sheets
        const SHEET_ID = '1IqkDZ9dnm_f_8WjUleAXoKAWytuz2WHxbWCc6Qqs4WQ';
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxErW-8sCzUPV7LglEwrJi79O77Ubow9W84KDHeGSbJRy960UW5YsZcm6FcKI1jBlZeyQ/exec';
        
        const BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=`;

        const RepartoAudiencias = () => {
            const [juzgados, setJuzgados] = useState([]);
            const [historial, setHistorial] = useState([]);
            const [siguienteJuzgado, setSiguienteJuzgado] = useState(null);
            const [tipoAudiencia, setTipoAudiencia] = useState('');
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState(null);
            const [ultimaActualizacion, setUltimaActualizacion] = useState(null);

            // Leer datos de Google Sheets
            const leerGoogleSheets = async () => {
                try {
                    setLoading(true);
                    setError(null);

                    // Leer Juzgados
                    const juzgadosResponse = await fetch(BASE_URL + 'Juzgados');
                    const juzgadosText = await juzgadosResponse.text();
                    const juzgadosJson = JSON.parse(juzgadosText.substring(47).slice(0, -2));
                    
                    const juzgadosData = juzgadosJson.table.rows.map(row => ({
                        id: row.c[0]?.v || 0,
                        nombre: row.c[1]?.v || '',
                        audiencias: row.c[2]?.v || 0,
                        activo: row.c[3]?.v === true || row.c[3]?.v === 'TRUE',
                        motivoInactivo: row.c[4]?.v || ''
                    }));

                    // Leer Historial
                    const historialResponse = await fetch(BASE_URL + 'Historial');
                    const historialText = await historialResponse.text();
                    const historialJson = JSON.parse(historialText.substring(47).slice(0, -2));
                    
                    const historialData = historialJson.table.rows
                        .filter(row => row.c[0]?.v)
                        .map(row => ({
                            audienciaNum: row.c[0]?.v || 0,
                            fecha: row.c[1]?.v || '',
                            juzgado: row.c[2]?.v || '',
                            tipo: row.c[3]?.v || ''
                        }));

                    setJuzgados(juzgadosData);
                    setHistorial(historialData);
                    setUltimaActualizacion(new Date().toLocaleTimeString('es-CO'));
                    setLoading(false);
                } catch (err) {
                    console.error('Error al leer Google Sheets:', err);
                    setError('Error al cargar datos. Verifica que la hoja sea p√∫blica.');
                    setLoading(false);
                }
            };

            // Guardar audiencia en Google Sheets
            const guardarAudiencia = async (audienciaData) => {
                try {
                    setSaving(true);
                    
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'agregarAudiencia',
                            ...audienciaData
                        })
                    });

                    setSaving(false);
                    return true;
                } catch (err) {
                    console.error('Error al guardar:', err);
                    setSaving(false);
                    return false;
                }
            };

            // Actualizar estado de juzgado
            const actualizarJuzgadoEnSheet = async (juzgadoData) => {
                try {
                    await fetch(WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'actualizarJuzgado',
                            ...juzgadoData
                        })
                    });
                    return true;
                } catch (err) {
                    console.error('Error al actualizar juzgado:', err);
                    return false;
                }
            };

            useEffect(() => {
                leerGoogleSheets();
                const interval = setInterval(leerGoogleSheets, 15000);
                return () => clearInterval(interval);
            }, []);

            const calcularSiguienteJuzgado = () => {
                const juzgadosActivos = juzgados.filter(j => j.activo);
                
                if (juzgadosActivos.length === 0) {
                    return null;
                }

                const minAudiencias = Math.min(...juzgadosActivos.map(j => j.audiencias));
                const candidatos = juzgadosActivos.filter(j => j.audiencias === minAudiencias);
                
                if (candidatos.length === 1) {
                    return candidatos[0];
                }
                
                return candidatos.reduce((prev, curr) => prev.id < curr.id ? prev : curr);
            };

            useEffect(() => {
                setSiguienteJuzgado(calcularSiguienteJuzgado());
            }, [juzgados]);

            const toggleJuzgado = async (id, motivo = '') => {
                const juzgado = juzgados.find(j => j.id === id);
                const nuevoEstado = !juzgado.activo;
                
                setJuzgados(juzgados.map(j => 
                    j.id === id ? { ...j, activo: nuevoEstado, motivoInactivo: nuevoEstado ? '' : motivo } : j
                ));

                await actualizarJuzgadoEnSheet({
                    id: id,
                    audiencias: juzgado.audiencias,
                    activo: nuevoEstado,
                    motivoInactivo: nuevoEstado ? '' : motivo
                });

                setTimeout(() => leerGoogleSheets(), 2000);
            };

            const asignarAudiencia = async () => {
                if (!siguienteJuzgado || !tipoAudiencia.trim()) {
                    alert('Por favor ingrese el tipo de audiencia');
                    return;
                }

                // Calcular el siguiente n√∫mero secuencial
                const ultimoNumero = historial.length > 0 
                    ? Math.max(...historial.map(h => h.audienciaNum || 0))
                    : 0;

                const nuevaEntrada = {
                    audienciaNum: ultimoNumero + 1,
                    fecha: new Date().toLocaleString('es-CO', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    }),
                    juzgado: siguienteJuzgado.nombre,
                    tipo: tipoAudiencia,
                    nuevasAudiencias: siguienteJuzgado.audiencias + 1
                };

                setHistorial([nuevaEntrada, ...historial]);
                setJuzgados(juzgados.map(j => 
                    j.id === siguienteJuzgado.id ? { ...j, audiencias: j.audiencias + 1 } : j
                ));

                setTipoAudiencia('');

                const guardado = await guardarAudiencia(nuevaEntrada);
                
                if (guardado) {
                    alert(`‚úÖ Audiencia asignada a ${siguienteJuzgado.nombre} y guardada en Google Sheets`);
                    setTimeout(() => leerGoogleSheets(), 3000);
                } else {
                    alert(`‚ö†Ô∏è La audiencia se asign√≥ localmente pero puede haber un problema al guardar.`);
                }
            };

            const ajustarAudiencias = async (id, cantidad) => {
                const juzgado = juzgados.find(j => j.id === id);
                const nuevasAudiencias = Math.max(0, juzgado.audiencias + cantidad);
                
                setJuzgados(juzgados.map(j => 
                    j.id === id ? { ...j, audiencias: nuevasAudiencias } : j
                ));

                await actualizarJuzgadoEnSheet({
                    id: id,
                    audiencias: nuevasAudiencias,
                    activo: juzgado.activo,
                    motivoInactivo: juzgado.motivoInactivo
                });

                setTimeout(() => leerGoogleSheets(), 2000);
            };

            const abrirGoogleSheet = () => {
                window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`, '_blank');
            };

            const exportarCSV = () => {
                let csv = 'N¬∞,Fecha/Hora,Juzgado,Tipo de Audiencia\n';
                historial.slice().reverse().forEach(entrada => {
                    csv += `${entrada.audienciaNum},"${entrada.fecha}","${entrada.juzgado}","${entrada.tipo}"\n`;
                });
                
                csv += '\n\nResumen de Juzgados\n';
                csv += 'Juzgado,Audiencias,Estado,Motivo Inactivo\n';
                juzgados.forEach(j => {
                    csv += `"${j.nombre}",${j.audiencias},"${j.activo ? 'Activo' : 'Inactivo'}","${j.motivoInactivo}"\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reparto-audiencias-${Date.now()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            if (loading && juzgados.length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen">
                        <div className="loading mb-4"></div>
                        <p className="text-gray-600">Cargando datos desde Google Sheets...</p>
                    </div>
                );
            }

            if (error && juzgados.length === 0) {
                return (
                    <div className="bg-red-50 border-2 border-red-500 rounded-lg p-6 m-6">
                        <h2 className="text-xl font-bold text-red-800 mb-2">‚ùå Error de Conexi√≥n</h2>
                        <p className="text-red-700 mb-4">{error}</p>
                        <button
                            onClick={leerGoogleSheets}
                            className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg"
                        >
                            Reintentar
                        </button>
                    </div>
                );
            }

            const juzgadosActivos = juzgados.filter(j => j.activo);
            const juzgadosInactivos = juzgados.filter(j => !j.activo);

            return (
                <div>
                    <div className="header-container mb-6">
                        <div className="flex items-center justify-between gap-4 mb-4">
                            <div className="logo-rama-judicial flex-shrink-0"></div>
                            
                            <div className="flex-1 text-center px-4">
                                <h1 className="text-2xl md:text-3xl font-bold text-white mb-2">
                                    Sistema de Reparto de Audiencias Complejas
                                </h1>
                                <p className="text-sm md:text-base text-white opacity-90">
                                    Centro de Servicios Judiciales Soacha Cundinamarca
                                </p>
                                <p className="text-xs text-white opacity-75 mt-1">
                                    Rep√∫blica de Colombia
                                </p>
                            </div>
                            
                            <div className="logo-ingenieria flex-shrink-0"></div>
                        </div>
                        
                        <div className="bg-white bg-opacity-20 rounded-lg p-4 backdrop-blur-sm">
                            <div className="flex flex-wrap justify-between items-center gap-4">
                                <div className="text-white">
                                    <p className="text-sm font-medium">Juzgados 1, 3, 5, 6, 7 - Reparto Secuencial Compensado</p>
                                    <p className="text-xs mt-1 opacity-90">
                                        ‚úÖ Guardado autom√°tico activado
                                    </p>
                                    {ultimaActualizacion && (
                                        <p className="text-xs opacity-75 mt-1">
                                            √öltima actualizaci√≥n: {ultimaActualizacion}
                                        </p>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={leerGoogleSheets}
                                        className="px-4 py-2 bg-white text-blue-700 hover:bg-gray-100 rounded-lg text-sm font-medium shadow-md transition-all"
                                        disabled={loading}
                                    >
                                        {loading ? '‚è≥' : 'üîÑ'} Actualizar
                                    </button>
                                    <button
                                        onClick={abrirGoogleSheet}
                                        className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium shadow-md transition-all"
                                    >
                                        üìä Abrir Sheet
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">üìÖ Estado de Juzgados</h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            {juzgados.map(juzgado => (
                                <div 
                                    key={juzgado.id} 
                                    className={`p-4 rounded-lg border-2 ${
                                        juzgado.activo 
                                            ? juzgado.id === siguienteJuzgado?.id 
                                                ? 'border-green-500 bg-green-50' 
                                                : 'border-gray-300 bg-white'
                                            : 'border-red-300 bg-red-50'
                                    }`}
                                >
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center">
                                            <h3 className="text-lg font-semibold">{juzgado.nombre}</h3>
                                            {juzgado.id === siguienteJuzgado?.id && juzgado.activo && (
                                                <span className="ml-2 px-2 py-1 bg-green-500 text-white text-xs rounded-full">
                                                    SIGUIENTE
                                                </span>
                                            )}
                                        </div>
                                        <button
                                            onClick={() => {
                                                if (!juzgado.activo) {
                                                    toggleJuzgado(juzgado.id);
                                                } else {
                                                    const motivo = prompt('Motivo de ausencia (permiso/incapacidad/compensatorio):');
                                                    if (motivo) toggleJuzgado(juzgado.id, motivo);
                                                }
                                            }}
                                            className={`px-3 py-1 rounded ${
                                                juzgado.activo 
                                                    ? 'bg-gray-500 hover:bg-gray-600' 
                                                    : 'bg-blue-500 hover:bg-blue-600'
                                            } text-white text-sm`}
                                        >
                                            {juzgado.activo ? 'Ausente' : 'Reintegrar'}
                                        </button>
                                    </div>
                                    
                                    <div className="flex items-center justify-between">
                                        <div>
                                            <p className="text-2xl font-bold text-gray-700">{juzgado.audiencias}</p>
                                            <p className="text-sm text-gray-500">Audiencias asignadas</p>
                                            {!juzgado.activo && (
                                                <p className="text-xs text-red-600 mt-1">
                                                    ‚ö†Ô∏è {juzgado.motivoInactivo}
                                                </p>
                                            )}
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => ajustarAudiencias(juzgado.id, -1)}
                                                className="p-2 bg-red-100 hover:bg-red-200 rounded"
                                                title="Reducir audiencias"
                                            >
                                                <span className="text-red-600 font-bold">‚àí</span>
                                            </button>
                                            <button
                                                onClick={() => ajustarAudiencias(juzgado.id, 1)}
                                                className="p-2 bg-blue-100 hover:bg-blue-200 rounded"
                                                title="Aumentar audiencias"
                                            >
                                                <span className="text-blue-600 font-bold">+</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="grid grid-cols-3 gap-4 p-4 bg-gray-100 rounded-lg">
                            <div className="text-center">
                                <p className="text-sm text-gray-600">Juzgados Activos</p>
                                <p className="text-2xl font-bold text-green-600">{juzgadosActivos.length}</p>
                            </div>
                            <div className="text-center">
                                <p className="text-sm text-gray-600">Juzgados Ausentes</p>
                                <p className="text-2xl font-bold text-red-600">{juzgadosInactivos.length}</p>
                            </div>
                            <div className="text-center">
                                <p className="text-sm text-gray-600">Total Audiencias</p>
                                <p className="text-2xl font-bold text-blue-600">
                                    {juzgados.reduce((sum, j) => sum + j.audiencias, 0)}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">üìù Asignar Nueva Audiencia</h2>
                        
                        {siguienteJuzgado ? (
                            <div className="space-y-4">
                                <div className="p-4 bg-green-50 border-2 border-green-500 rounded-lg">
                                    <p className="text-sm text-gray-600 mb-1">Pr√≥xima audiencia ser√° asignada a:</p>
                                    <p className="text-2xl font-bold text-green-700">{siguienteJuzgado.nombre}</p>
                                    <p className="text-sm text-gray-600 mt-1">
                                        Audiencias actuales: {siguienteJuzgado.audiencias}
                                    </p>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        C√≥digo √önico de Identificaci√≥n
                                    </label>
                                    <input
                                        type="text"
                                        value={tipoAudiencia}
                                        onChange={(e) => setTipoAudiencia(e.target.value)}
                                        placeholder="Ej: 257546000392202512345"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                        onKeyPress={(e) => e.key === 'Enter' && asignarAudiencia()}
                                    />
                                </div>
                                
                                <button
                                    onClick={asignarAudiencia}
                                    className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors disabled:bg-gray-400"
                                    disabled={saving}
                                >
                                    {saving ? 'üíæ Guardando en Google Sheets...' : '‚úÖ Asignar y Guardar Audiencia'}
                                </button>
                            </div>
                        ) : (
                            <div className="p-4 bg-yellow-50 border-2 border-yellow-500 rounded-lg">
                                <span className="text-yellow-800 font-medium">
                                    ‚ö†Ô∏è No hay juzgados activos disponibles. Reactive al menos un juzgado para continuar.
                                </span>
                            </div>
                        )}
                    </div>

                    <div className="bg-white rounded-lg shadow-lg p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-gray-800">üìã Historial de Reparto</h2>
                            <button
                                onClick={exportarCSV}
                                className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm"
                            >
                                üì• Exportar CSV
                            </button>
                        </div>
                        
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-100">
                                    <tr>
                                        <th className="px-4 py-2 text-left text-sm font-semibold text-gray-700">#</th>
                                        <th className="px-4 py-2 text-left text-sm font-semibold text-gray-700">Fecha/Hora</th>
                                        <th className="px-4 py-2 text-left text-sm font-semibold text-gray-700">Juzgado</th>
                                        <th className="px-4 py-2 text-left text-sm font-semibold text-gray-700">Tipo de Audiencia</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {historial.length === 0 ? (
                                        <tr>
                                            <td colSpan="4" className="px-4 py-8 text-center text-gray-500">
                                                No hay audiencias registradas a√∫n
                                            </td>
                                        </tr>
                                    ) : (
                                        historial.slice().reverse().map((entrada, index) => (
                                            <tr key={index} className="border-b border-gray-200 hover:bg-gray-50">
                                                <td className="px-4 py-3 text-sm">{entrada.audienciaNum}</td>
                                                <td className="px-4 py-3 text-sm">{entrada.fecha}</td>
                                                <td className="px-4 py-3 text-sm font-semibold">{entrada.juzgado}</td>
                                                <td className="px-4 py-3 text-sm">{entrada.tipo}</td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Footer */}
                    <footer className="bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-lg shadow-lg p-6 mt-6">
                        <div className="max-w-4xl mx-auto">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="text-lg font-bold mb-3 text-blue-300">Desarrollado por</h3>
                                    <p className="text-sm mb-1">
                                        <span className="font-semibold">Ing. Edgar A Hern√°ndez Lemus</span>
                                    </p>
                                    <p className="text-sm text-gray-300 mb-1">
                                        üìç Carrera 4 N¬∞ 38-66 Piso 1
                                    </p>
                                    <p className="text-sm text-gray-300">
                                        Soacha, Cundinamarca
                                    </p>
                                </div>
                                
                                <div>
                                    <h3 className="text-lg font-bold mb-3 text-blue-300">Contacto</h3>
                                    <p className="text-sm mb-2">
                                        üì± <a href="tel:3166245436" className="hover:text-blue-300 transition-colors">316 624 5436</a>
                                    </p>
                                    <p className="text-sm">
                                        üìß <a href="mailto:ehernanle@cendoj.ramajudicial.gov.co" className="hover:text-blue-300 transition-colors break-all">
                                            ehernanle@cendoj.ramajudicial.gov.co
                                        </a>
                                    </p>
                                </div>
                            </div>
                            
                            <div className="border-t border-gray-700 mt-6 pt-4 text-center">
                                <p className="text-xs text-gray-400">
                                    ¬© {new Date().getFullYear()} Centro de Servicios Judiciales Soacha - Rama Judicial
                                </p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        ReactDOM.render(<RepartoAudiencias />, document.getElementById('app'));
    </script>
</body>
</html>